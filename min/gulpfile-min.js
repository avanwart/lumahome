var argv=require("minimist")(process.argv.slice(2)),autoprefixer=require("gulp-autoprefixer"),browserSync=require("browser-sync").create(),changed=require("gulp-changed"),concat=require("gulp-concat"),flatten=require("gulp-flatten"),gulp=require("gulp"),gulpif=require("gulp-if"),imagemin=require("gulp-imagemin"),jshint=require("gulp-jshint"),lazypipe=require("lazypipe"),merge=require("merge-stream"),cssNano=require("gulp-cssnano"),plumber=require("gulp-plumber"),rev=require("gulp-rev"),runSequence=require("run-sequence"),sass=require("gulp-sass"),sourcemaps=require("gulp-sourcemaps"),uglify=require("gulp-uglify"),postcss=require("gulp-postcss"),lost=require("lost"),jade=require("gulp-jade-php"),manifest=require("asset-builder")("./assets/manifest.json"),path=manifest.paths,config=manifest.config||{},globs=manifest.globs,project=manifest.getProjectGlobs(),enabled={rev:argv.production,maps:!argv.production,failStyleTask:argv.production,failJSHint:argv.production,stripJSDebug:argv.production},revManifest=path.dist.assets+"assets.json",cssTasks=function(e){return lazypipe().pipe(function(){return gulpif(!enabled.failStyleTask,plumber())}).pipe(function(){return gulpif(enabled.maps,sourcemaps.init())}).pipe(function(){return gulpif("*.scss",sass({outputStyle:"nested",precision:10,includePaths:["."],errLogToConsole:!enabled.failStyleTask}))}).pipe(function(){return gulpif("*.css",postcss([lost]))}).pipe(concat,e).pipe(autoprefixer,{browsers:["last 2 versions","android 4","opera 12"]}).pipe(cssNano,{safe:!0}).pipe(function(){return gulpif(enabled.rev,rev())}).pipe(function(){return gulpif(enabled.maps,sourcemaps.write(".",{sourceRoot:"assets/styles/"}))})()},jsTasks=function(e){return lazypipe().pipe(function(){return gulpif(enabled.maps,sourcemaps.init())}).pipe(concat,e).pipe(uglify,{compress:{drop_debugger:enabled.stripJSDebug}}).pipe(function(){return gulpif(enabled.rev,rev())}).pipe(function(){return gulpif(enabled.maps,sourcemaps.write(".",{sourceRoot:"assets/scripts/"}))})()},writeToManifest=function(e){return lazypipe().pipe(gulp.dest,path.dist.assets+e).pipe(browserSync.stream,{match:"**/*.{js,css}"}).pipe(rev.manifest,revManifest,{base:path.dist.assets,merge:!0}).pipe(gulp.dest,path.dist.assets)()};gulp.task("styles",["wiredep"],function(){var e=merge();return manifest.forEachDependency("css",function(s){var t=cssTasks(s.name);enabled.failStyleTask||t.on("error",function(e){console.error(e.message),this.emit("end")}),e.add(gulp.src(s.globs,{base:"styles"}).pipe(t))}),e.pipe(writeToManifest("styles"))}),gulp.task("scripts",["jshint"],function(){var e=merge();return manifest.forEachDependency("js",function(s){e.add(gulp.src(s.globs,{base:"scripts"}).pipe(jsTasks(s.name)))}),e.pipe(writeToManifest("scripts"))}),gulp.task("templates",function(){return gulp.src(path.source+"templates/**/*").pipe(jade({pretty:!0})).pipe(gulp.dest(path.dist.templates))}),gulp.task("fonts",function(){return gulp.src(globs.fonts).pipe(flatten()).pipe(gulp.dest(path.dist.assets+"fonts")).pipe(browserSync.stream())}),gulp.task("images",function(){return gulp.src(globs.images).pipe(imagemin({progressive:!0,interlaced:!0,svgoPlugins:[{removeUnknownsAndDefaults:!1},{cleanupIDs:!1}]})).pipe(gulp.dest(path.dist.assets+"images")).pipe(browserSync.stream())}),gulp.task("jshint",function(){return gulp.src(["bower.json","gulpfile.js"].concat(project.js)).pipe(jshint()).pipe(jshint.reporter("jshint-stylish")).pipe(gulpif(enabled.failJSHint,jshint.reporter("fail")))}),gulp.task("clean",require("del").bind(null,[path.dist.assets,path.dist.templates])),gulp.task("watch",function(){browserSync.init({files:["{lib,templates}/**/*.php","*.php"],proxy:config.devUrl,snippetOptions:{whitelist:["/wp-admin/admin-ajax.php"],blacklist:["/wp-admin/**"]}}),gulp.watch([path.source+"styles/**/*"],["styles"]),gulp.watch([path.source+"templates/**/*"],["templates"]),gulp.watch([path.source+"scripts/**/*"],["jshint","scripts"]),gulp.watch([path.source+"fonts/**/*"],["fonts"]),gulp.watch([path.source+"images/**/*"],["images"]),gulp.watch(["bower.json","assets/manifest.json"],["build"])}),gulp.task("build",function(e){runSequence("templates","styles","scripts",["fonts","images"],e)}),gulp.task("wiredep",function(){var e=require("wiredep").stream;return gulp.src(project.css).pipe(e()).pipe(changed(path.source+"styles",{hasChanged:changed.compareSha1Digest})).pipe(gulp.dest(path.source+"styles"))}),gulp.task("default",["clean"],function(){gulp.start("build")});